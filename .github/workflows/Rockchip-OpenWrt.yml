name: immortalwrt_rockchip_docker

on:
  schedule:
    - cron: "0 16 * * *"
  workflow_dispatch:

env:
  REPO_URL: https://github.com/immortalwrt/immortalwrt
  REPO_BRANCH: openwrt-24.10
  CONFIG_FILE: configs/rockchip.config
  UPLOAD_FIRMWARE: true
  UPLOAD_RELEASE: true
  TZ: Asia/Shanghai

jobs:
  build:
    runs-on: ubuntu-22.04

    steps:
    - name: Checkout
      uses: actions/checkout@v4

    - name: Init & show system info
      run: |
        echo "==== 系统信息 ===="
        uname -a
        echo "==== 磁盘信息 ===="
        df -h
        echo "==== 内存信息 ===="
        free -h
        chmod +x diy-script.sh
        ./diy-script.sh

    - name: Clone source code
      run: |
        git clone --depth 1 -b $REPO_BRANCH $REPO_URL openwrt

    - name: Load feeds.conf.default
      run: |
        cd openwrt
        $GITHUB_WORKSPACE/diy-script.sh

    - name: Load config
      run: |
        [ -e "$CONFIG_FILE" ] && cat "$CONFIG_FILE" > openwrt/.config
        cd openwrt
        $GITHUB_WORKSPACE/diy-script.sh

    - name: Make download
      run: |
        cd openwrt
        make defconfig
        make download -j8

    - name: Compile firmware
      run: |
        cd openwrt
        make -j$(nproc) || make -j1 V=s

    - name: Upload firmware directory
      if: env.UPLOAD_FIRMWARE == 'true'
      uses: actions/upload-artifact@v4
      with:
        name: OpenWrt_firmware
        path: openwrt/bin/targets/

    - name: Create release
      if: env.UPLOAD_RELEASE == 'true'
      uses: softprops/action-gh-release@v2
      with:
        tag_name: OpenWrt-rockchip-${{ github.run_number }}
        name: OpenWrt rockchip build ${{ github.run_number }}
        body: |
          自动构建的 OpenWrt 固件 (Rockchip)
        files: openwrt/bin/targets/**/*
